#!/usr/bin/env python

import sys
from argparse import ArgumentParser
from braceexpand import braceexpand

import requests


def clone(options):
    cookies = {
        "frontend_lang": "en_US",
        "tz": "Europe/Brussels",
    }

    headers = {
        "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7",
        "Accept-Language": "en-GB,en-US;q=0.9,en;q=0.8",
        "Cache-Control": "no-cache",
        "Connection": "keep-alive",
        "Content-Type": "application/x-www-form-urlencoded",
        "Origin": f"http://localhost:{options.port}",
        "Pragma": "no-cache",
        "Referer": f"http://localhost:{options.port}/web/database/manager",
    }

    targets = list(braceexpand(options.target))

    # ask user for confirmation
    print(f"clone {options.database} into {targets}?")
    if input("y/n: ") != "y":
        print("aborted")
        sys.exit(0)

    for target_name in targets:
        data = {
            "master_pwd": options.master_password,
            "name": options.database,
            "new_name": target_name,
        }
        response = requests.post(
            f"http://localhost:{options.port}/web/database/duplicate",
            cookies=cookies,
            headers=headers,
            data=data,
        )
        print(
            response.status_code,
            response.reason,
            f"from {options.database} to {target_name}",
        )


def main() -> int:
    parser = ArgumentParser(
        description="db_clone :: clone a database using the odoo web interface"
    )
    parser.add_argument(
        "-d", "--database", help="Name of the source database", type=str, required=True
    )
    parser.add_argument(
        "-t",
        "--target",
        help="Name patten of clones to create. i.e. main{-{1..9},} for main + main-1 to main-9",
        type=str,
        required=True,
    )
    parser.add_argument(
        "-p", "--port", help="Port of the odoo instance", type=int, default=8069
    )
    parser.add_argument(
        "-mp",
        "--master-password",
        help="Master Password of the odoo instance",
        default="Password",
    )
    options = parser.parse_args()
    clone(options)


if __name__ == "__main__":
    sys.exit(main())
